version: "3.9"
services:
  blockscout:
    depends_on:
      - postgres
      - sequencer
    build:
      context: blockscout
      dockerfile: docker/Dockerfile
    restart: always
    container_name: 'blockscout'
    links:
      - postgres:database
    command: 'sh -c "mix do ecto.create, ecto.migrate; node init/install.js postgres 5432; mix do phx.server"'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      -  ./blockscout/nitro.env
    environment:
        ETHEREUM_JSONRPC_VARIANT: 'geth'
        ETHEREUM_JSONRPC_HTTP_URL: http://sequencer:7545/
        INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
        DATABASE_URL: postgresql://postgres:@postgres:5432/blockscout?ssl=false
        ECTO_USE_SSL: "false"
    ports:
      - 4000:4000

  postgres:
    image: postgres:13.6
    restart: always
    container_name: 'postgres'
    environment:
        POSTGRES_PASSWORD: ''
        POSTGRES_USER: 'postgres'
        POSTGRES_HOST_AUTH_METHOD: 'trust'
    volumes:
      - "postgres-data:/var/lib/postgresql/data"
    ports:
      - 7432:5432

  redis:
    image: redis:6.2.6
    ports:
      - "6379:6379"

  geth:
    image: ethereum/client-go:stable
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
    volumes:
      - "l1data:/root/.ethereum"
      - "l1keystore:/keystore"
    command: --keystore /keystore --http --http.addr 0.0.0.0 --http.vhosts * --http.api personal,eth,net,web3 --http.corsdomain * --ws --ws.addr 0.0.0.0 --ws.api personal,eth,net,web3,debug,txpool --dev --dev.period 1 --password /root/.ethereum/passphrase --gcmode archive

  sequencer:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7545:7545"
      - "7546:7546"
      - "9642:9642"
    volumes:
      - "seqdata:/data"
      - "config:/config"
    command: --conf.file /config/sequencer_config.json --node.feed.output.enable --node.feed.output.port 9642 --http.vhosts * --http.api net,web3,eth,txpool,debug --http.corsdomain * --node.seq-coordinator.my-url  ws://sequencer:7546
    depends_on:
      - geth
      - redis

  sequencer_b:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7545"
      - "7546"
    volumes:
      - "seqdata_b:/data"
      - "config:/config"
    command: --conf.file /config/sequencer_config.json --node.seq-coordinator.my-url ws://sequencer_b:7546
    depends_on:
      - geth
      - redis

  sequencer_c:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7545"
      - "7546"
    volumes:
      - "seqdata_c:/data"
      - "config:/config"
    command: --conf.file /config/sequencer_config.json --node.seq-coordinator.my-url ws://sequencer_c:7546
    depends_on:
      - geth
      - redis

  sequencer_d:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7545"
      - "7546"
    volumes:
      - "seqdata_d:/data"
      - "config:/config"
    command: --conf.file /config/sequencer_config.json --node.seq-coordinator.my-url ws://sequencer_d:7546
    depends_on:
      - geth
      - redis

  staker-unsafe:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7545"
      - "7546"
    volumes:
      - "unsafestaker-data:/data"
      - "l1keystore:/l1keystore"
      - "config:/config"
    command: --conf.file /config/unsafe_staker_config.json
    depends_on:
      - sequencer
      - redis

  poster:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7547"
      - "7548"
    volumes:
      - "poster-data:/data"
      - "l1keystore:/l1keystore"
      - "config:/config"
    command: --conf.file /config/poster_config.json
    depends_on:
      - geth
      - redis

  validator:
    pid: host # allow debugging
    build:
      context: .
      target: nitro-node
    ports:
      - "7547:7547"
      - "7548:7548"
    volumes:
      - "validator-data:/data"
      - "l1keystore:/l1keystore"
      - "config:/config"
    command: --conf.file /config/validator_config.json --http.port 7547 --http.api net,web3,arb,debug --ws.port 7548
    depends_on:
      - sequencer

  testnode-scripts:
    build: testnode-scripts/
    volumes:
      - "l1keystore:/l1keystore"
      - "config:/config"
    depends_on:
      - geth
      - redis

  relay:
    pid: host
    build:
      context: .
      target: nitro-node
    ports:
      - "9652:9652"
    entrypoint: bin/relay
    command: --node.feed.output.port 9652 --node.feed.input.url ws://sequencer:9642/feed

volumes:
  l1data:
  l1keystore:
  seqdata:
  seqdata_b:
  seqdata_c:
  seqdata_d:
  unsafestaker-data:
  validator-data:
  poster-data:
  config:
  postgres-data:

